//
//  DashboardViewController.swift
//  MyUglyPet
//
//  Created by Ïù¥Ïú§ÏßÄ on 8/20/24.
//
//

import UIKit
import SnapKit
import RxSwift
import RxCocoa
import Kingfisher

// Ìè¨Ïä§Ìä∏ Í∑∏Î£πÏùÑ Ï†ïÏùòÌïòÎäî Íµ¨Ï°∞Ï≤¥ + Í∑∏Î£πÌôîÌï†Îïå 3Í∞ÄÏßÄ Ï°∞Í±¥Ïù¥ ÎßûÏúºÎ©¥ Í∑∏Î£πÌôîÌï®
struct PostGroup: Hashable {
    let title: String
    let content: String
    let content1: String
   // let files: String
    // filesÎäî ÎπÑÍµêÏóêÏÑú Ï†úÏô∏Îê©ÎãàÎã§.
}


// ÏÑúÎ≤ÑÏóêÏÑú Í∞íÏùÑ Î∞õÍ≥† Îû≠ÌÇπ ÏÖÄÏóê ÎÑ£ÏùÑ Íµ¨Ï°∞Ï≤¥
struct finalPostGroup: Hashable {
    let title: String
    let content: String
    let content1: String
    let files: [String] // ÌååÏùº URL Î∞∞Ïó¥ÏùÑ Ï†ÄÏû•
}



// ÎçîÎØ∏ Îç∞Ïù¥ÌÑ∞ Î∞∞Ïó¥
let bannerData: [(image: UIImage, title: String)] = [
    (image: UIImage(named: "Í∏∞Î≥∏ÎÉ•Î©ç1")!, title: "Î∞∞ÎÑà Ï†úÎ™© 1"),
    (image: UIImage(named: "Í∏∞Î≥∏ÎÉ•Î©ç2")!, title: "Î∞∞ÎÑà Ï†úÎ™© 2"),
    (image: UIImage(named: "Í∏∞Î≥∏ÎÉ•Î©ç3")!, title: "Î∞∞ÎÑà Ï†úÎ™© 3")
]

class DashboardViewController: UIViewController {
    
    let scrollView = UIScrollView()
    let contentStackView = UIStackView()
    

    let logoLabel: UILabel = {
        let label = UILabel()
        label.text = "ÎÉ•Î©çÎÇúÏù¥"
        label.font = UIFont.boldSystemFont(ofSize: 30)
        return label
    }()
    

    let searchButton: UIButton = {
        let button = UIButton(type: .system)
        button.setImage(UIImage(systemName: "magnifyingglass"), for: .normal)
        button.tintColor = .black
        return button
    }()
    
    // Î∞∞ÎÑà ÏÑπÏÖò Ìó§Îçî
    let bannerHeaderLabel: UILabel = {
        let label = UILabel()
        label.text = "Î∞∞ÎÑà"
        label.font = UIFont.boldSystemFont(ofSize: 20)
        return label
    }()
    
    // Î∞∞ÎÑà Ïª¨Î†âÏÖò Î∑∞
    let bannerCollectionView: UICollectionView = {
        let layout = UICollectionViewFlowLayout()
        layout.scrollDirection = .horizontal
        layout.itemSize = CGSize(width: UIScreen.main.bounds.width - 32, height: 150)
        layout.minimumLineSpacing = 10
        let collectionView = UICollectionView(frame: .zero, collectionViewLayout: layout)
        collectionView.register(BannerCollectionViewCell.self, forCellWithReuseIdentifier: BannerCollectionViewCell.identifier)
        collectionView.showsHorizontalScrollIndicator = false
        collectionView.isPagingEnabled = true
        collectionView.backgroundColor = .clear
        return collectionView
    }()
    
    // ÌéòÏù¥ÏßÄ Ïª®Ìä∏Î°§
    let pageControl: UIPageControl = {
        let pageControl = UIPageControl()
        pageControl.currentPage = 0
        pageControl.pageIndicatorTintColor = .lightGray
        pageControl.currentPageIndicatorTintColor = .black
        pageControl.addTarget(self, action: #selector(pageControlValueChanged(_:)), for: .valueChanged)
        return pageControl
    }()
    
    // ÏàúÏúÑ ÏÑπÏÖò Ìó§Îçî
    let rankHeaderLabel: UILabel = {
        let label = UILabel()
        label.text = "ÏàúÏúÑ"
        label.font = UIFont.boldSystemFont(ofSize: 20)
        return label
    }()
    
    // ÏàúÏúÑ Ïª¨Î†âÏÖò Î∑∞
    let rankCollectionView: UICollectionView = {
        let layout = UICollectionViewFlowLayout()
        layout.scrollDirection = .horizontal
        layout.itemSize = CGSize(width: 120, height: 160)
        layout.minimumLineSpacing = 10
        let collectionView = UICollectionView(frame: .zero, collectionViewLayout: layout)
        collectionView.register(RankCollectionViewCell.self, forCellWithReuseIdentifier: RankCollectionViewCell.identifier)
        collectionView.showsHorizontalScrollIndicator = false
        collectionView.backgroundColor = CustomColors.softPink
        return collectionView
    }()
    
    // Ï∑®ÎØ∏ Ïπ¥Îìú ÏÑπÏÖò Ìó§Îçî
    let hobbyCardHeaderLabel: UILabel = {
        let label = UILabel()
        label.text = "Ï∑®ÎØ∏ Ïπ¥Îìú"
        label.font = UIFont.boldSystemFont(ofSize: 20)
        return label
    }()
    
    // Ï∑®ÎØ∏ Ïπ¥Îìú Ïª¨Î†âÏÖò Î∑∞
    let hobbyCardCollectionView: UICollectionView = {
        let layout = UICollectionViewFlowLayout()
        layout.scrollDirection = .vertical
        layout.itemSize = CGSize(width: UIScreen.main.bounds.width - 32, height: 100)
        layout.minimumLineSpacing = 10
        let collectionView = UICollectionView(frame: .zero, collectionViewLayout: layout)
        collectionView.register(HobbyCardCollectionViewCell.self, forCellWithReuseIdentifier: HobbyCardCollectionViewCell.identifier)
        collectionView.showsVerticalScrollIndicator = false
        collectionView.backgroundColor = CustomColors.softPurple
        return collectionView
    }()
    
    
    var rankedGroups: [(key: PostGroup, value: [PostsModel])] = []

    override func viewWillAppear(_ animated: Bool) {
        fetchHashtagPosts(hashTag: "1Îì±Ïù¥Îã∑")
    }
    
    
    
    override func viewDidLoad() {
        super.viewDidLoad()
        
        bannerCollectionView.dataSource = self
        rankCollectionView.dataSource = self
        hobbyCardCollectionView.dataSource = self
        
        bannerCollectionView.delegate = self
        rankCollectionView.delegate = self
        hobbyCardCollectionView.delegate = self
        
        // Î∞∞ÎÑàÏùò ÌéòÏù¥ÏßÄ ÏàòÏóê ÎßûÏ∂∞ ÌéòÏù¥ÏßÄ Ïª®Ìä∏Î°§ ÏÑ§Ï†ï
        pageControl.numberOfPages = bannerData.count
        
        setupSubviews()
        setupConstraints()
    }
    
    func setupSubviews() {
        view.backgroundColor = CustomColors.lightBeige
        

        view.addSubview(scrollView)
        scrollView.addSubview(contentStackView)
        
        contentStackView.axis = .vertical
        contentStackView.spacing = 16
        contentStackView.isLayoutMarginsRelativeArrangement = true
        contentStackView.layoutMargins = UIEdgeInsets(top: 0, left: 10, bottom: 0, right: 0) // Ï¢åÏ∏°Ïóê 10pt Ïó¨Î∞± Ï∂îÍ∞Ä
        
        // Î°úÍ≥† Î∞è Í≤ÄÏÉâ Î≤ÑÌäº Ï∂îÍ∞Ä
        let headerStackView = UIStackView(arrangedSubviews: [logoLabel, searchButton])
        headerStackView.axis = .horizontal
        headerStackView.spacing = 16
        contentStackView.addArrangedSubview(headerStackView)
        
        // Î∞∞ÎÑà ÏÑπÏÖò Ï∂îÍ∞Ä
        contentStackView.addArrangedSubview(bannerHeaderLabel)
        contentStackView.addArrangedSubview(bannerCollectionView)
        contentStackView.addArrangedSubview(pageControl)
        
        // ÏàúÏúÑ ÏÑπÏÖò Ï∂îÍ∞Ä
        contentStackView.addArrangedSubview(rankHeaderLabel)
        contentStackView.addArrangedSubview(rankCollectionView)
        
        // Ï∑®ÎØ∏ Ïπ¥Îìú ÏÑπÏÖò Ï∂îÍ∞Ä
        contentStackView.addArrangedSubview(hobbyCardHeaderLabel)
        contentStackView.addArrangedSubview(hobbyCardCollectionView)
    }
    
    func setupConstraints() {
        // ScrollView Ï†úÏïΩ Ï°∞Í±¥
        scrollView.snp.makeConstraints { make in
            make.edges.equalTo(view.safeAreaLayoutGuide)
        }
        
        contentStackView.snp.makeConstraints { make in
            make.edges.equalTo(scrollView)
            make.width.equalTo(scrollView)
        }
        
        bannerCollectionView.snp.makeConstraints { make in
            make.height.equalTo(150)
        }
        
        rankCollectionView.snp.makeConstraints { make in
            make.height.equalTo(230)
        }
        
        hobbyCardCollectionView.snp.makeConstraints { make in
            make.height.equalTo(400) // ÌïÑÏöî Ïãú Ï°∞Ï†ï Í∞ÄÎä•
        }
    }
    
    // ÌéòÏù¥ÏßÄ Ïª®Ìä∏Î°§ Í∞í Î≥ÄÍ≤Ω Ïãú Ìò∏Ï∂úÎêòÎäî Î©îÏÑúÎìú
    @objc func pageControlValueChanged(_ sender: UIPageControl) {
        let indexPath = IndexPath(item: sender.currentPage, section: 0)
        bannerCollectionView.scrollToItem(at: indexPath, at: .centeredHorizontally, animated: true)
    }
}




extension DashboardViewController: UICollectionViewDataSource, UICollectionViewDelegate {
    func numberOfSections(in collectionView: UICollectionView) -> Int {
        return 1
    }
    
    func collectionView(_ collectionView: UICollectionView, numberOfItemsInSection section: Int) -> Int {
        switch collectionView {
            
        case bannerCollectionView:
            return bannerData.count
            
        case rankCollectionView:
            print("üë∫\(rankedGroups.count)")
            return rankedGroups.count
            
            
        case hobbyCardCollectionView:
            return 10
            
        default:
            return 0
        }
    }
    
    func imageURLString(_ path: String) -> String {
        return path
    }

    
    func collectionView(_ collectionView: UICollectionView, cellForItemAt indexPath: IndexPath) -> UICollectionViewCell {
        switch collectionView {
        case bannerCollectionView:
            let cell = collectionView.dequeueReusableCell(withReuseIdentifier: BannerCollectionViewCell.identifier, for: indexPath) as! BannerCollectionViewCell
            let data = bannerData[indexPath.item]
            cell.configure(with: data.image, title: data.title)
            return cell
            
        case rankCollectionView:
                   guard let cell = collectionView.dequeueReusableCell(withReuseIdentifier: RankCollectionViewCell.identifier, for: indexPath) as? RankCollectionViewCell else {
                       return UICollectionViewCell()
                   }

                   let group = rankedGroups[indexPath.item]
                   let rank = indexPath.item + 1
                   
                   if let fileUrls = group.value.first?.files, let firstFileUrl = fileUrls.first {
                       let fullImageURLString = APIKey.baseURL + "v1/" + firstFileUrl

                       
                       print("üôá‚Äç‚ôÄÔ∏è\(fullImageURLString)")
                       
                       if let imageURL = URL(string: fullImageURLString) {
                           // Ìó§Îçî ÏÑ§Ï†ï
                           let headers: [String: String] = [
                               Header.sesacKey.rawValue: APIKey.key,
                               Header.authorization.rawValue: UserDefaultsManager.shared.token ?? ""
                           ]
                           
                           // KingfisherÏùò AnyModifierÎ•º ÏÇ¨Ïö©ÌïòÏó¨ ÏöîÏ≤≠ ÏàòÏ†ï
                           let modifier = AnyModifier { request in
                               var r = request
                               r.allHTTPHeaderFields = headers
                               return r
                           }
                           
                           cell.profileImageView.kf.setImage(
                               with: imageURL,
                               placeholder: UIImage(systemName: "photo"), // Í∏∞Î≥∏ placeholder Ïù¥ÎØ∏ÏßÄ
                               options: [.requestModifier(modifier)]
                           ) { result in
                               switch result {
                               case .success(let value):
                                   print("Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏÑ±Í≥µü•π: \(value.source.url?.absoluteString ?? "")")
                               case .failure(let error):
                                   print("Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®ü•π: \(error.localizedDescription)")
                               }
                           }
                       } else {
                           print("URL Î≥ÄÌôòÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§ü•π: \(fullImageURLString)")
                       }
                   }
                   
            cell.configure(with: UIImage(systemName: "star"), name: " \(group.key.title)", description: "\(group.key.content1)", rank: "\(rank)Îì±")
                   
                   return cell
            
        case hobbyCardCollectionView:
            let cell = collectionView.dequeueReusableCell(withReuseIdentifier: HobbyCardCollectionViewCell.identifier, for: indexPath) as! HobbyCardCollectionViewCell
            cell.configure(with: UIImage(named: "Í∏∞Î≥∏ÎÉ•Î©ç1")!, title: "Ïú†Ï†Ä \(indexPath.row + 1)", description: "Ïù¥Í≤ÉÏùÄ Ï∑®ÎØ∏ Ïπ¥Îìú ÏÑ§Î™ÖÏûÖÎãàÎã§.")
            return cell
            
        default:
            return UICollectionViewCell()
        }
    }
    
    func scrollViewDidEndDecelerating(_ scrollView: UIScrollView) {
        if scrollView == bannerCollectionView {
            let page = Int(scrollView.contentOffset.x) / Int(scrollView.frame.width)
            pageControl.currentPage = page
        }
    }
}


extension DashboardViewController {

    // Ìï¥ÏãúÌÉúÍ∑∏Î•º ÏÇ¨Ïö©ÌïòÏó¨ Ìè¨Ïä§ÌåÖ Í∞ÄÏ†∏Ïò§Í∏∞
    private func fetchHashtagPosts(hashTag: String) {
        let query = FetchHashtagReadingPostQuery(next: nil, limit: "30", product_id: "Í∞ÅÏú†Ï†ÄÍ∞ÄÍ≥†Î•∏1Îì±Ïö∞ÏäπÏûê", hashTag: hashTag)

        PostNetworkManager.shared.fetchHashtagPosts(query: query) { [weak self] result in
            switch result {
            case .success(let posts):
                // Î™®Îì† Ìè¨Ïä§Ìä∏ Ï∂úÎ†•
                self?.printAllPosts(posts)
                // Ìè¨Ïä§Ìä∏Î•º Ï≤òÎ¶¨ÌïòÏó¨ Îû≠ÌÇπ Í≥ÑÏÇ∞
                self?.processFetchedPosts(posts)
            case .failure(let error):
                print("Ìï¥ÏãúÌÉúÍ∑∏Î°ú Ìè¨Ïä§ÌåÖÏùÑ Í∞ÄÏ†∏Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏñ¥Ïöîü•∫„Ö†„Öú: \(error.localizedDescription)")
            }
        }
    }

    // Î™®Îì† Ìè¨Ïä§Ìä∏Î•º Ï∂úÎ†•
    private func printAllPosts(_ posts: [PostsModel]) {
        for (index, post) in posts.enumerated() {
            print("===== Ìè¨Ïä§Ìä∏ \(index + 1) =====")
            print("Ìè¨Ïä§Ìä∏ ÌÉÄÏù¥ÌãÄ: \(post.title ?? "Ï†úÎ™© ÏóÜÏùå")")
            print("Ìè¨Ïä§Ìä∏ ÎÇ¥Ïö©: \(post.content ?? "ÎÇ¥Ïö© ÏóÜÏùå")")
            print("Ìè¨Ïä§Ìä∏ ÎÇ¥Ïö©1: \(post.content1 ?? "ÎÇ¥Ïö©1 ÏóÜÏùå")")
            print("Ìè¨Ïä§Ìä∏ ÌååÏùº URLÎì§: \(post.files ?? [])")
            print("========================\n")
        }
    }

    // Í∞ÄÏ†∏Ïò® Ìè¨Ïä§Ìä∏Î•º Ï≤òÎ¶¨
    private func processFetchedPosts(_ posts: [PostsModel]) {
        // Ìè¨Ïä§Ìä∏Î•º Í∑∏Î£πÌôîÌïòÏó¨ Í∞úÏàòÎ•º Í≥ÑÏÇ∞
        let groupedPosts = groupPosts(posts: posts)
        
        // Í∞úÏàòÎ°ú Ï†ïÎ†¨ÌïòÏó¨ ÏàúÏúÑÎ•º Îß§ÍπÄ
        let rankedGroups = rankGroups(groupedPosts)
        
        // Î™®Îì† ÏàúÏúÑ Ï∂úÎ†•
        displayRankedGroups(rankedGroups)
    }

    // Ìè¨Ïä§Ìä∏Î•º Í∑∏Î£πÌôîÌïòÏó¨ Ï§ëÎ≥µ Í∞úÏàò Í≥ÑÏÇ∞
    private func groupPosts(posts: [PostsModel]) -> [PostGroup: [PostsModel]] {
        var groupedPosts = [PostGroup: [PostsModel]]()
        
        for post in posts {
            let postGroup = PostGroup(
                title: post.title ?? "Ï†úÎ™© ÏóÜÏùå",
                content: post.content ?? "ÎÇ¥Ïö© ÏóÜÏùå",
                content1: post.content1 ?? "ÎÇ¥Ïö©1 ÏóÜÏùå"
            )
            
            groupedPosts[postGroup, default: []].append(post)
        }
        
        return groupedPosts
    }

    // Í∑∏Î£πÌôîÎêú Ìè¨Ïä§Ìä∏Î•º Í∞úÏàòÎ°ú Ï†ïÎ†¨ÌïòÏó¨ ÏàúÏúÑÎ•º Îß§ÍπÄ
    private func rankGroups(_ groupedPosts: [PostGroup: [PostsModel]]) -> [(key: PostGroup, value: [PostsModel])] {
        return groupedPosts.sorted { $0.value.count > $1.value.count }
    }

    // Î™®Îì† ÏàúÏúÑ Ï∂úÎ†•
    private func displayRankedGroups(_ rankedGroups: [(key: PostGroup, value: [PostsModel])]) {
        guard !rankedGroups.isEmpty else {
            print("Îû≠ÌÇπÏóê ÌëúÏãúÌï† Í∑∏Î£πÏù¥ ÏóÜÏäµÎãàÎã§.")
            return
        }
        
        for (index, group) in rankedGroups.enumerated() {
            print("\(index + 1)Îì± Í∑∏Î£πÏùò ÌÉÄÏù¥ÌãÄ: \(group.key.title)")
            print("\(index + 1)Îì± Í∑∏Î£πÏùò ÎÇ¥Ïö©: \(group.key.content)")
            print("\(index + 1)Îì± Í∑∏Î£πÏùò ÎÇ¥Ïö©1: \(group.key.content1)")
            print("\(index + 1)Îì± Í∑∏Î£πÏùò Ï§ëÎ≥µÎêú Ìè¨Ïä§Ìä∏ Í∞úÏàò: \(group.value.count)Í∞ú") // Ìï¥Îãπ Í∑∏Î£πÏóê Î™á Í∞úÏùò Ìè¨Ïä§Ìä∏Í∞Ä ÏûàÎäîÏßÄ Ï∂úÎ†•

            // Í∑∏Î£πÏóê Ìè¨Ìï®Îêú Ìè¨Ïä§Ìä∏Îì§ÏùÑ Î™®Îëê Ï∂úÎ†•
            for (postIndex, post) in group.value.enumerated() {
                print("    Ìè¨Ìï®Îêú Ìè¨Ïä§Ìä∏ \(postIndex + 1): ÌÉÄÏù¥ÌãÄ: \(post.title ?? "Ï†úÎ™© ÏóÜÏùå"), ÌååÏùº URL: \(post.files ?? [])")
            }
            
            print("========================\n")
        }
        
        self.rankedGroups = rankedGroups
        print("Í∑∏Î£πÏù¥ Ïûò Îì§Ïñ¥Í∞îÎÇò?: \(rankedGroups)")
        rankCollectionView.reloadData()
        
        
    }
    
    
 
    
}


final class RankCollectionViewCell: UICollectionViewCell {

    let containerView: UIView = {
        let view = UIView()
        view.backgroundColor = CustomColors.softBlue
        view.layer.cornerRadius = 20
        view.layer.shadowColor = UIColor.black.cgColor
        view.layer.shadowOpacity = 0.1
        view.layer.shadowOffset = CGSize(width: 0, height: 5)
        view.layer.shadowRadius = 10
        return view
    }()
    
    let profileImageView: UIImageView = {
        let imageView = UIImageView()
        imageView.contentMode = .scaleAspectFit
        imageView.image = UIImage(systemName: "figure.stand")
        imageView.clipsToBounds = true
        imageView.layer.cornerRadius = 75 // Half of the height/width for a circular view
        return imageView
    }()
    
    let rankLabel: UILabel = {
        let label = UILabel()
        label.backgroundColor = UIColor.yellow
        label.textColor = .black
        label.textAlignment = .center
        label.font = UIFont.boldSystemFont(ofSize: 16)
        label.layer.cornerRadius = 10
        label.layer.masksToBounds = true
        label.text = "1Îì±"
        return label
    }()
    
    let nameLabel: UILabel = {
        let label = UILabel()
        label.text = "Íº¨ÏßàÏù¥Îãò"
        label.font = UIFont.systemFont(ofSize: 16)
        label.textAlignment = .center
        return label
    }()
    
    let descriptionLabel: UILabel = {
        let label = UILabel()
        label.text = "Í≤¨ÏÉù 5ÎÖÑÏ∞®"
        label.font = UIFont.systemFont(ofSize: 14)
        label.textAlignment = .center
        label.textColor = .gray
        return label
    }()
    
    override init(frame: CGRect) {
        super.init(frame: frame)
        setupUI()
    }
    
    required init?(coder: NSCoder) {
        fatalError("init(coder:) has not been implemented")
    }
    
    func setupUI() {
        contentView.addSubview(containerView)
        containerView.addSubview(profileImageView)
        containerView.addSubview(rankLabel)
        containerView.addSubview(nameLabel)
        containerView.addSubview(descriptionLabel)
        
        containerView.snp.makeConstraints { make in
            make.edges.equalToSuperview()
        }
        
        profileImageView.snp.makeConstraints { make in
            make.top.equalToSuperview().offset(-20)
            make.centerX.equalToSuperview()
            make.width.height.equalTo(120)
        }
        
        rankLabel.snp.makeConstraints { make in
            make.top.equalToSuperview().offset(-10)
            make.leading.equalToSuperview().offset(-10)
            make.width.equalTo(40)
            make.height.equalTo(40)
        }
        
        nameLabel.snp.makeConstraints { make in
            make.top.equalTo(profileImageView.snp.bottom).offset(10)
            make.centerX.equalToSuperview()
        }
        
        descriptionLabel.snp.makeConstraints { make in
            make.top.equalTo(nameLabel.snp.bottom).offset(5)
            make.centerX.equalToSuperview()
        }
    }
    
    func configure(with image: UIImage?, name: String, description: String, rank: String) {
        profileImageView.image = image
        nameLabel.text = name
        descriptionLabel.text = description
        rankLabel.text = rank
    }
}










